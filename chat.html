<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>ìœ¨í†¡</title>

  <!-- íŒŒë¹„ì½˜ ëŒ€ì‹  ì´ëª¨ì§€ ì‚¬ìš© -->
  <link rel="icon"
    href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ°</text></svg>">

  <!-- í°íŠ¸: ê°ìê½ƒ (Gamja Flower) -->
  <link href="https://fonts.googleapis.com/css2?family=Gamja+Flower&display=swap" rel="stylesheet">

  <style>
    /* =========================================
       [Reset & Base Variables]
       ========================================= */
    :root {
      --primary-color: #FFD1DC;
      /* íŒŒìŠ¤í…” í•‘í¬ */
      --secondary-color: #FFF9C4;
      /* íŒŒìŠ¤í…” ì˜ë¡œìš° */
      --bg-color: #FFFDF5;
      /* í¬ë¦¼ìƒ‰ ë°°ê²½ */
      --text-color: #5D4037;
      /* ë”°ëœ»í•œ ê°ˆìƒ‰ */
      --bubble-mine: #FFEBEE;
      --bubble-yours: #FFFFFF;
      --point-color: #FF8A80;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      background-color: var(--bg-color);
      font-family: 'Gamja Flower', cursive;
      /* í°íŠ¸ ì ìš© */
      font-size: 1.1rem;
      color: var(--text-color);

      /* [Layout Fix] ê°€ë¡œ ìŠ¤í¬ë¡¤ ë°©ì§€ ë° ë†’ì´ ê³ ì • */
      width: 100%;
      height: 100%;
      overflow: hidden;
      position: fixed;
      /* iOS ê³ ë¬´ë°´ë“œ íš¨ê³¼ ë°©ì§€ ë° ì „ì²´ í™”ë©´ ê³ ì • */
    }

    /* =========================================
       [Splash Screen (Login)]
       ========================================= */
    #splash-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--primary-color);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      transition: opacity 0.5s ease-out;
    }

    .splash-content {
      text-align: center;
      background: rgba(255, 255, 255, 0.9);
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      width: 80%;
      max-width: 300px;
    }

    .splash-title {
      font-size: 2rem;
      margin-bottom: 20px;
      color: #E57373;
    }

    .user-btn {
      width: 100%;
      padding: 15px;
      margin: 10px 0;
      border: none;
      border-radius: 15px;
      font-family: inherit;
      font-size: 1.2rem;
      cursor: pointer;
      background: var(--bg-color);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      transition: transform 0.1s;
    }

    .user-btn:active {
      transform: scale(0.95);
    }

    .user-btn.dad {
      border: 2px solid #81C784;
      color: #2E7D32;
    }

    .user-btn.yul {
      border: 2px solid #FF8A80;
      color: #C62828;
    }

    /* =========================================
       [Main Chat Layout]
       ========================================= */
    #chat-screen {
      display: flex;
      flex-direction: column;
      height: 100%;
      width: 100%;
      display: none;
      /* ì´ˆê¸°ì—” ìˆ¨ê¹€ (ë¡œê·¸ì¸ í›„ ë³´ì„) */
    }

    /* Header */
    header {
      background: rgba(255, 255, 255, 0.95);
      padding: 10px 15px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 1px 5px rgba(0, 0, 0, 0.05);
      z-index: 10;
      padding-top: calc(10px + env(safe-area-inset-top));
    }

    .header-title {
      font-size: 1.4rem;
      font-weight: bold;
      color: #E57373;
    }

    .header-right {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .point-badge {
      background: #FFF9C4;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.9rem;
      border: 2px solid #FBC02D;
      color: #F57F17;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .logout-btn {
      background: none;
      border: none;
      font-size: 0.8rem;
      color: #999;
      text-decoration: underline;
      cursor: pointer;
      font-family: inherit;
    }

    /* Chat Container */
    #chat-container {
      flex: 1;
      padding: 15px;
      overflow-y: scroll;
      background: var(--bg-color);
      /* ê·€ì—¬ìš´ ë°°ê²½ íŒ¨í„´ */
      background-image: radial-gradient(#FFEBEE 2px, transparent 2px);
      background-size: 30px 30px;
      display: flex;
      flex-direction: column;
      gap: 15px;
      padding-bottom: 20px;
      /* ì…ë ¥ì°½ ê³µê°„ í™•ë³´ëŠ” jsë¡œ ì²˜ë¦¬ or padding */

      /* ìŠ¤í¬ë¡¤ ë¶€ë“œëŸ½ê²Œ */
      -webkit-overflow-scrolling: touch;
    }

    /* Message Rows */
    .message-row {
      display: flex;
      align-items: flex-end;
      margin-bottom: 10px;
    }

    .profile-img {
      width: 40px;
      height: 40px;
      border-radius: 40%;
      /* ë‘¥ê¸€ë‘¥ê¸€ */
      background: #eee;
      object-fit: cover;
      border: 2px solid #fff;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      margin-right: 8px;
    }

    .bubble-wrapper {
      display: flex;
      flex-direction: column;
      max-width: 70%;
      position: relative;
    }

    .msg-bubble {
      padding: 10px 15px;
      border-radius: 18px;
      font-size: 1.1rem;
      line-height: 1.4;
      position: relative;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      word-break: break-all;
    }

    .msg-bubble img {
      max-width: 100%;
      border-radius: 10px;
      display: block;
    }

    .msg-info {
      display: flex;
      align-items: flex-end;
      gap: 4px;
      font-size: 0.8rem;
      color: #888;
      margin-bottom: 2px;
    }

    /* Read Receipt '1' */
    .unread-mark {
      color: #FBC02D;
      /* ì¹´ì¹´ì˜¤í†¡ ë…¸ë€ìƒ‰ ëŠë‚Œ */
      font-weight: bold;
      font-size: 0.7rem;
    }

    /* Mine (Right) */
    .mine {
      justify-content: flex-end;
    }

    .mine .profile-img {
      display: none;
      /* ë‚´ í”„ì‚¬ ìˆ¨ê¹€ */
    }

    .mine .bubble-wrapper {
      align-items: flex-end;
    }

    .mine .msg-bubble {
      background: var(--bubble-mine);
      border-bottom-right-radius: 4px;
    }

    .mine .msg-info {
      flex-direction: row-reverse;
      /* ì‹œê°„, ì½ìŒí‘œì‹œ ìˆœì„œ */
    }

    /* Yours (Left) */
    .yours {
      justify-content: flex-start;
    }

    .yours .msg-bubble {
      background: var(--bubble-yours);
      border-bottom-left-radius: 4px;
    }

    .yours .msg-info {
      flex-direction: row;
    }

    /* Date Divider */
    .date-divider {
      text-align: center;
      margin: 20px 0;
    }

    .date-divider span {
      background: rgba(0, 0, 0, 0.05);
      padding: 5px 12px;
      border-radius: 15px;
      font-size: 0.9rem;
      color: #777;
    }

    /* Input Area */
    .input-area {
      background: #fff;
      padding: 10px;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
      z-index: 20;
      padding-bottom: calc(10px + env(safe-area-inset-bottom));
      width: 100%;
      /* ë„ˆë¹„ ê°•ì œ */
    }

    .emoji-bar {
      display: flex;
      gap: 10px;
      padding-bottom: 10px;
      overflow-x: auto;
      /* ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ */
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .emoji-bar::-webkit-scrollbar {
      display: none;
    }

    .emoji-btn {
      background: #F5F5F5;
      border: none;
      border-radius: 12px;
      padding: 5px 10px;
      font-size: 1.2rem;
      cursor: pointer;
      flex-shrink: 0;
      /* ì°Œê·¸ëŸ¬ì§ ë°©ì§€ */
    }

    .input-row {
      display: flex;
      align-items: center;
      gap: 8px;
      width: 100%;
    }

    .action-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 5px;
      flex-shrink: 0;
    }

    #msg-input {
      flex: 1;
      padding: 12px;
      border: 1px solid #eee;
      background: #F9F9F9;
      border-radius: 25px;
      font-family: inherit;
      font-size: 1rem;
      outline: none;
      min-width: 0;
      /* í”Œë ‰ìŠ¤ ì•„ì´í…œ ë„˜ì¹¨ ë°©ì§€ */
    }

    #send-btn {
      background: var(--point-color);
      color: #fff;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 1.2rem;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(255, 138, 128, 0.4);
      flex-shrink: 0;
    }

    /* =========================================
       [Stamp Board Modal]
       ========================================= */
    #stamp-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(5px);
    }

    .stamp-board {
      background: #fff;
      width: 90%;
      max-width: 350px;
      border-radius: 20px;
      padding: 20px;
      text-align: center;
      position: relative;
      background-image: linear-gradient(#F0F4C3 1px, transparent 1px), linear-gradient(90deg, #F0F4C3 1px, transparent 1px);
      background-size: 20px 20px;
      background-color: #fff;
    }

    .close-btn {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 1.5rem;
      border: none;
      background: none;
      cursor: pointer;
      color: #aaa;
    }

    .stamp-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      margin: 20px 0;
    }

    .stamp-slot {
      width: 100%;
      aspect-ratio: 1;
      border: 2px dashed #ddd;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 1.5rem;
      background: #fff;
    }

    .stamp-slot.filled {
      border: 2px solid #FF8A80;
      background: #FFEBEE;
      animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    @keyframes popIn {
      0% {
        transform: scale(0);
      }

      100% {
        transform: scale(1);
      }
    }

    .stamp-action-btn {
      background: #FF8A80;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 20px;
      font-family: inherit;
      font-size: 1.1rem;
      cursor: pointer;
      width: 100%;
      margin-top: 10px;
    }

    .stamp-action-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
  </style>
</head>

<body>

  <!-- [1] ìŠ¤í”Œë˜ì‹œ í™”ë©´ (ë¡œê·¸ì¸) -->
  <div id="splash-screen">
    <div class="splash-content">
      <div class="splash-title">ëˆ„êµ¬ì„¸ìš”? ğŸ¤”</div>
      <button class="user-btn dad" onclick="selectUser('ì•„ë¹ ')">ğŸ‘¨ğŸ» ì•„ë¹ </button>
      <button class="user-btn yul" onclick="selectUser('ìœ¨ì´')">ğŸ‘§ğŸ» ìœ¨ì´</button>
    </div>
  </div>

  <!-- [2] ë©”ì¸ ì±„íŒ… í™”ë©´ -->
  <div id="chat-screen">
    <header>
      <div class="header-title">ìœ¨í†¡ ğŸ’•</div>
      <div class="header-right">
        <div class="point-badge" id="gecko-point-badge" onclick="openStampBoard()">
          ğŸ¦ <span id="gecko-point-val">0</span>
        </div>
        <button class="logout-btn" onclick="logout()">ë‚˜ê°€ê¸°</button>
      </div>
    </header>

    <div id="chat-container">
      <div style="text-align:center; color:#aaa; font-size:0.9rem; margin-top:20px;">
        êµ¬ë¦„ ìœ„ë¡œ ë©”ì‹œì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘... â˜ï¸
      </div>
    </div>

    <!-- ìŠ¤í¬ë¡¤ ê°ì§€ìš© í•˜ë‹¨ ì•µì»¤ -->
    <div id="bottom-anchor"></div>

    <div class="input-area">
      <!-- 1. ì´ëª¨í‹°ì½˜/ë„ì¥ í€µ ë²„íŠ¼ -->
      <div class="emoji-bar">
        <button class="emoji-btn" onclick="addEmoji('â¤ï¸')">â¤ï¸</button>
        <button class="emoji-btn" onclick="addEmoji('ğŸ˜Š')">ğŸ˜Š</button>
        <button class="emoji-btn" onclick="addEmoji('ğŸ˜­')">ğŸ˜­</button>
        <button class="emoji-btn" onclick="addEmoji('â˜ï¸')">â˜ï¸</button>
        <button class="emoji-btn" onclick="addEmoji('ğŸ°')">ğŸ°</button>
        <button class="emoji-btn" onclick="addEmoji('ğŸ¦')">ğŸ¦</button>
      </div>

      <!-- 2. ì…ë ¥ ë° ì „ì†¡ -->
      <div class="input-row">
        <button class="action-btn" onclick="document.getElementById('img-input').click()">ğŸ“·</button>
        <button class="action-btn" onclick="openStampBoard()" style="font-size:1.3rem;">ğŸ’®</button>

        <input type="file" id="img-input" accept="image/*" style="display: none;">
        <input type="text" id="msg-input" placeholder="ë©”ì‹œì§€ ì…ë ¥..." autocomplete="off">

        <button id="send-btn">â¬†</button>
      </div>
    </div>
  </div>

  <!-- [3] ë„ì¥íŒ ëª¨ë‹¬ -->
  <div id="stamp-modal">
    <div class="stamp-board">
      <button class="close-btn" onclick="closeStampBoard()">Ã—</button>
      <h3>ì°¸ ì˜í–ˆì–´ìš”! ğŸ’®</h3>
      <p style="font-size:0.9rem; color:#888;">ë„ì¥ 10ê°œë¥¼ ëª¨ìœ¼ë©´ 100 ê²Œì½” í¬ì¸íŠ¸!</p>

      <div class="stamp-grid" id="stamp-grid">
        <!-- JSë¡œ ìŠ¬ë¡¯ 10ê°œ ìƒì„± -->
      </div>

      <p>í˜„ì¬ í¬ì¸íŠ¸: ğŸ¦ <strong id="modal-point-val" style="color:#F57F17; font-size:1.2rem;">0</strong> P</p>

      <!-- ì•„ë¹ ë§Œ ë³´ì„ -->
      <button id="give-stamp-btn" class="stamp-action-btn" style="display:none;" onclick="giveStamp()">
        ë„ì¥ ì°ì–´ì£¼ê¸°! ì¾…! ğŸ’®
      </button>
    </div>
  </div>

  <!-- Firebase Scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script> <!-- Auth ì¶”ê°€ -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
  <script src="books/config.js"></script>

  <script>
    /* =========================================
       [Firebase Init]
       ========================================= */
    const firebaseConfig = {
      apiKey: "AIzaSyB_mGDSlGtox4DN6HsL8SDcX6gzoVO1V8M", // ê¸°ì¡´ Key ìœ ì§€
      authDomain: "yul-apps.firebaseapp.com",
      projectId: "yul-apps",
      storageBucket: "yul-apps.firebasestorage.app",
      messagingSenderId: "1025363432906",
      appId: "1:1025363432906:web:9c55059683677b3a9f2b33"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();
    const auth = firebase.auth(); // Auth ì´ˆê¸°í™”

    // ì˜¤í”„ë¼ì¸ ì§€ì†ì„±
    db.enablePersistence().catch(err => console.log("Persistence Error", err.code));

    // [ìµëª… ë¡œê·¸ì¸] ì‚¬ì§„ ì—…ë¡œë“œ ê¶Œí•œì„ ìœ„í•´ í•„ìš”
    auth.signInAnonymously()
      .then(() => {
        console.log("Signed in anonymously");
      })
      .catch((error) => {
        console.error("Error signing in anonymously:", error);
      });

    /* =========================================
       [Global State & Utils]
       ========================================= */
    let myName = localStorage.getItem('chatUser'); // 'ì•„ë¹ ' or 'ìœ¨ì´' or null
    let otherName = null;
    let otherUserLastRead = 0; // Timestamp (milliseconds)

    // assets
    const SOUND_URL = "https://firebasestorage.googleapis.com/v0/b/yul-apps.firebasestorage.app/o/sounds%2Fyul-talk.mp3?alt=media&token=02b2a1aa-c06f-4f62-ba9e-db2cdf25268e";
    const DAD_IMG = "https://cdn.imgbin.com/16/17/13/imgbin-steve-jobs-memorial-apple-icon-steve-jobs-steve-jobs-0tbHUhDyd0Yqt7vs6CAeBtubw.jpg";
    const YUL_IMG = "https://i.pinimg.com/564x/a5/61/9e/a5619e9ef5949fb35e71523644ea6c24.jpg";

    function getProfileImg(name) {
      return name === 'ì•„ë¹ ' ? DAD_IMG : YUL_IMG;
    }

    /* =========================================
       [User Logic: Login / Logout]
       ========================================= */
    function checkLogin() {
      if (myName) {
        document.getElementById('splash-screen').style.display = 'none';
        document.getElementById('chat-screen').style.display = 'flex';

        otherName = (myName === 'ì•„ë¹ ') ? 'ìœ¨ì´' : 'ì•„ë¹ ';

        if (myName === 'ì•„ë¹ ') {
          document.getElementById('give-stamp-btn').style.display = 'block';
        }

        initializeApp();
      } else {
        document.getElementById('splash-screen').style.display = 'flex';
        document.getElementById('chat-screen').style.display = 'none';
      }
    }

    function selectUser(user) {
      localStorage.setItem('chatUser', user);
      myName = user;

      const splash = document.getElementById('splash-screen');
      splash.style.opacity = '0';
      setTimeout(() => checkLogin(), 500);

      unlockAudio();
    }

    function logout() {
      if (confirm("ì •ë§ ë¡œê·¸ì•„ì›ƒ í• ê¹Œìš”?")) {
        localStorage.removeItem('chatUser');
        location.reload();
      }
    }

    /* =========================================
       [Core Logic: Read Receipts & Presence]
       ========================================= */
    function updateMyLastRead() {
      if (!myName) return;
      db.collection('users').doc(myName).set({
        lastRead: firebase.firestore.FieldValue.serverTimestamp(),
        online: true
      }, { merge: true });
    }

    function listenToOtherUser() {
      if (!otherName) return;
      db.collection('users').doc(otherName).onSnapshot(doc => {
        if (doc.exists) {
          const data = doc.data();
          if (data.lastRead) {
            otherUserLastRead = data.lastRead.toMillis();
            renderStart();
          }
        }
      });
    }

    /* =========================================
       [Core Logic: Chat Rendering]
       ========================================= */
    let unsubscribeMsg = null;
    const PAGE_SIZE = 50;

    function initializeApp() {
      updateMyLastRead();
      listenToOtherUser();
      listenToStamps();

      if (unsubscribeMsg) unsubscribeMsg();

      const q = db.collection('messages').orderBy('timestamp', 'asc').limitToLast(PAGE_SIZE);

      unsubscribeMsg = q.onSnapshot(snapshot => {
        const container = document.getElementById('chat-container');

        if (container.innerText.includes('êµ¬ë¦„')) {
          container.innerHTML = "";
        }

        snapshot.docChanges().forEach(change => {
          if (change.type === "added") {
            const msgDiv = createMessageDiv(change.doc);
            container.appendChild(msgDiv);

            const data = change.doc.data();
            if (data.sender !== myName) {
              playNotification();
            }
          }
        });

        scrollToBottom();
        updateMyLastRead();
      });

      setInterval(updateMyLastRead, 60000);
    }

    function createMessageDiv(doc) {
      const data = doc.data();
      const isMine = data.sender === myName;
      const msgId = doc.id;

      const row = document.createElement('div');
      row.className = `message-row ${isMine ? 'mine' : 'yours'}`;
      row.dataset.id = msgId;
      row.dataset.timestamp = data.timestamp ? data.timestamp.toMillis() : Date.now();

      if (!isMine) {
        const img = document.createElement('img');
        img.src = getProfileImg(data.sender);
        img.className = 'profile-img';
        row.appendChild(img);
      }

      const wrapper = document.createElement('div');
      wrapper.className = 'bubble-wrapper';

      const bubble = document.createElement('div');
      bubble.className = 'msg-bubble';

      if (data.imageUrl) {
        const img = document.createElement('img');
        img.src = data.imageUrl;
        bubble.appendChild(img);
      }
      if (data.text) {
        const span = document.createElement('div');
        span.innerText = data.text;
        bubble.appendChild(span);
      }
      wrapper.appendChild(bubble);

      const info = document.createElement('div');
      info.className = 'msg-info';

      let timeStr = "";
      if (data.timestamp) {
        const date = data.timestamp.toDate();
        let h = date.getHours();
        let m = String(date.getMinutes()).padStart(2, '0');
        const ampm = h >= 12 ? 'ì˜¤í›„' : 'ì˜¤ì „';
        h = h % 12 || 12;
        timeStr = `${ampm} ${h}:${m}`;
      }
      const timeSpan = document.createElement('span');
      timeSpan.innerText = timeStr;

      const readSpan = document.createElement('span');
      readSpan.className = 'unread-mark';
      readSpan.innerText = '1';
      checkReadStatus(readSpan, row.dataset.timestamp);

      info.appendChild(readSpan);
      info.appendChild(timeSpan);

      wrapper.appendChild(info);
      row.appendChild(wrapper);

      return row;
    }

    function checkReadStatus(el, msgTimestamp) {
      if (otherUserLastRead >= msgTimestamp) {
        el.style.display = 'none';
      } else {
        el.style.display = 'inline';
      }
    }

    function renderStart() {
      const marks = document.querySelectorAll('.unread-mark');
      marks.forEach(mark => {
        const row = mark.closest('.message-row');
        if (row && row.dataset.timestamp) {
          checkReadStatus(mark, parseInt(row.dataset.timestamp));
        }
      });
    }

    function scrollToBottom() {
      const container = document.getElementById('chat-container');
      container.scrollTop = container.scrollHeight;
    }

    function sendMessage(text, imgUrl = null) {
      if (!text && !imgUrl) return;

      db.collection('messages').add({
        sender: myName, // 'ì•„ë¹ ' or 'ìœ¨ì´'
        text: text,
        imageUrl: imgUrl,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      }).then(() => {
        document.getElementById('msg-input').value = "";
        scrollToBottom();
      });
    }

    /* =========================================
       [Interactive: Sound & Emoji]
       ========================================= */

    let audioUnlocked = false;
    function unlockAudio() {
      if (audioUnlocked) return;
      audioUnlocked = true;

      const audio = new Audio(SOUND_URL);
      audio.volume = 0;
      audio.play().catch(e => {
        console.log("Audio autoplay blocked");
        audioUnlocked = false; // try again on next click
      });

      document.body.removeEventListener('click', unlockAudio);
      document.body.removeEventListener('touchstart', unlockAudio);
    }
    document.body.addEventListener('click', unlockAudio);
    document.body.addEventListener('touchstart', unlockAudio, { passive: true });

    function playNotification() {
      const audio = new Audio(SOUND_URL);
      audio.volume = 1.0;
      audio.play().catch(e => { });
    }

    window.addEmoji = (emoji) => {
      const input = document.getElementById('msg-input');
      input.value += emoji;
      input.focus();
    };

    document.getElementById('send-btn').addEventListener('click', () => {
      sendMessage(document.getElementById('msg-input').value);
    });

    document.getElementById('msg-input').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage(e.target.value);
    });

    /* =========================================
       [Feature: Stamp Board & Gecko Points]
       ========================================= */

    const STAMP_TARGET = 10;
    const POINT_REWARD = 100;

    function listenToStamps() {
      db.collection('users').doc('ìœ¨ì´').onSnapshot(doc => {
        if (!doc.exists) return;
        const data = doc.data();
        const count = data.stampCount || 0;
        const points = data.geckoPoints || 0;

        document.getElementById('gecko-point-val').innerText = points;
        document.getElementById('modal-point-val').innerText = points;

        renderStamps(count);
      });
    }

    function renderStamps(count) {
      const grid = document.getElementById('stamp-grid');
      grid.innerHTML = "";

      for (let i = 0; i < STAMP_TARGET; i++) {
        const slot = document.createElement('div');
        slot.className = `stamp-slot ${i < count ? 'filled' : ''}`;
        slot.innerText = i < count ? 'ğŸ’®' : (i + 1);
        grid.appendChild(slot);
      }
    }

    function openStampBoard() {
      document.getElementById('stamp-modal').style.display = 'flex';
    }

    function closeStampBoard() {
      document.getElementById('stamp-modal').style.display = 'none';
    }

    function giveStamp() {
      const ref = db.collection('users').doc('ìœ¨ì´');

      db.runTransaction(async (transaction) => {
        const doc = await transaction.get(ref);
        if (!doc.exists) return;

        let newCount = (doc.data().stampCount || 0) + 1;
        let newPoints = (doc.data().geckoPoints || 0);

        if (newCount >= STAMP_TARGET) {
          newCount = 0;
          newPoints += POINT_REWARD;
          alert("ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! ë„ì¥ 10ê°œë¥¼ ëª¨ì•„ì„œ 100 ê²Œì½” í¬ì¸íŠ¸ë¥¼ ë°›ì•˜ì–´ìš”! ğŸ¦ğŸ’°");
          sendMessage("ğŸ‰ [ì•Œë¦¼] ìœ¨ì´ê°€ ë„ì¥ì„ ë‹¤ ëª¨ì•„ì„œ 100 ê²Œì½” í¬ì¸íŠ¸ë¥¼ ë°›ì•˜ì–´ìš”! ì¶•í•˜í•´! ğŸ’•");
        }

        transaction.update(ref, { stampCount: newCount, geckoPoints: newPoints });
      }).then(() => {
        alert("ë„ì¥ì„ ì°ì—ˆìŠµë‹ˆë‹¤! ì¾…!");
      }).catch(err => {
        alert("ë„ì¥ ì°ê¸° ì‹¤íŒ¨ ã… ã… : " + err);
      });
    }

    /* =========================================
       [Image Upload Logic]
       ========================================= */
    const imgInput = document.getElementById('img-input');
    imgInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;

      if (!confirm("ì´ ì‚¬ì§„ì„ ì „ì†¡í• ê¹Œìš”?")) return;

      const fileName = Date.now() + '_' + file.name;
      const ref = storage.ref().child('chat_images_v2/' + fileName);

      document.getElementById('msg-input').placeholder = "ì‚¬ì§„ ì—…ë¡œë“œ ì¤‘... â˜ï¸";

      ref.put(file).then(snapshot => snapshot.ref.getDownloadURL()).then(url => {
        sendMessage(null, url);
        document.getElementById('msg-input').placeholder = "ë©”ì‹œì§€ ì…ë ¥...";
      }).catch(err => {
        console.error(err);
        // êµ¬ì²´ì ì¸ ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
        let msg = "ì‚¬ì§„ ì „ì†¡ ì‹¤íŒ¨ ã… ã… ";
        if (err.code === 'storage/unauthorized') {
          msg += "\n(ì›ì¸: ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. Firebase Consoleì—ì„œ 'Anonymous' ë¡œê·¸ì¸ì„ ì¼œì£¼ì„¸ìš”!)";
        } else {
          msg += "\n(" + err.message + ")";
        }
        alert(msg);
        document.getElementById('msg-input').placeholder = "ë©”ì‹œì§€ ì…ë ¥...";
      });

      imgInput.value = "";
    });

    // Start
    checkLogin();

  </script>
</body>

</html>