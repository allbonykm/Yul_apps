<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ğŸ„ í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ëë§ì‡ê¸° í›ˆë ¨ ğŸ…</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        /* [ë””ìì¸ ì„¤ì •] í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ê°ì„±ìœ¼ë¡œ ìƒ‰ìƒë§Œ êµì²´í–ˆìŠµë‹ˆë‹¤ */
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #d62828 0%, #006400 100%);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* ëˆˆ ë‚´ë¦¬ëŠ” ë°°ê²½ íš¨ê³¼ */
        .snow-container {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 0;
        }
        .snowflake {
            position: absolute; background: white; border-radius: 50%;
            opacity: 0.8; animation: fall linear infinite;
        }
        @keyframes fall {
            0% { transform: translateY(-10vh) translateX(0); }
            100% { transform: translateY(110vh) translateX(20px); }
        }

        /* ë²„íŠ¼ ë° ë ˆì´ì•„ì›ƒ (ê¸°ì¡´ ìœ„ì¹˜ ë™ì¼) */
        .back-button {
            position: fixed; top: 20px; left: 20px;
            background: white; border: 3px solid #d62828;
            width: 50px; height: 50px; border-radius: 50%;
            font-size: 24px; cursor: pointer; z-index: 1000;
            display: flex; align-items: center; justify-content: center;
        }

        .hint-button, .defense-button {
            position: fixed; top: 20px; color: white; border: 2px solid white;
            padding: 12px 20px; border-radius: 25px; font-weight: 700;
            cursor: pointer; z-index: 1000; transition: 0.3s;
        }
        .hint-button { right: 140px; background: #fb8500; }
        .defense-button { right: 20px; background: #ef476f; }

        /* ë©”ì¸ ì»¨í…Œì´ë„ˆ */
        .container { position: relative; z-index: 1; max-width: 800px; margin: 0 auto; padding: 20px; }
        .title { font-size: 32px; font-weight: 900; color: white; text-align: center; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); margin-bottom: 10px; }
        
        .gecko-points {
            display: block; margin: 0 auto; background: white; padding: 10px 25px;
            border-radius: 25px; font-weight: 700; color: #006400; text-align: center; width: fit-content;
        }

        /* íˆìŠ¤í† ë¦¬ ë° ìºë¦­í„° ì˜ì—­ */
        .history-bar { background: rgba(255, 255, 255, 0.9); border-radius: 20px; padding: 15px; margin: 20px 0; min-height: 80px; overflow-x: auto; }
        .word-bubbles { display: flex; gap: 10px; align-items: center; }
        .word-bubble { padding: 10px 20px; border-radius: 20px; color: white; font-weight: 700; animation: bubblePop 0.3s ease; }
        .word-bubble.user { background: #d62828; }
        .word-bubble.ai { background: #2b9348; }

        .battle-stage { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; position: relative; }
        .character { text-align: center; flex: 1; }
        .character-image { width: 140px; height: 140px; border-radius: 50%; border: 5px solid white; object-fit: cover; background: white; }
        .vs-badge { background: #ffb703; color: #d62828; font-weight: 900; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 3px solid white; }

        /* ì…ë ¥ ì˜ì—­ */
        .input-area { background: rgba(255, 255, 255, 0.95); border-radius: 25px; padding: 25px; }
        .mic-button { width: 90px; height: 90px; border-radius: 50%; background: #2b9348; border: 4px solid white; font-size: 40px; color: white; cursor: pointer; margin: 0 auto 15px; display: block; }
        .mic-button.listening { background: #ff0000; animation: pulse 1s infinite; }
        
        .text-input { width: 100%; max-width: 400px; padding: 12px; border: 3px solid #ffb703; border-radius: 20px; font-size: 18px; outline: none; }
        .submit-button { background: #d62828; color: white; border: none; padding: 10px 25px; border-radius: 20px; font-weight: 700; cursor: pointer; margin-top: 10px; }

        /* ìŠ¹ë¦¬ íŒì—… */
        .victory-popup { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .victory-popup.show { display: flex; }
        .victory-content { background: white; border: 8px solid #ffb703; border-radius: 30px; padding: 40px; text-align: center; max-width: 400px; }

        /* íŒíŠ¸ íŒ¨ë„ */
        .hint-panel { position: fixed; top: 0; right: -400px; width: 400px; height: 100vh; background: white; z-index: 1500; transition: 0.3s; padding: 60px 20px; overflow-y: auto; }
        .hint-panel.open { right: 0; }
        .killer-word-item { background: #d62828; color: white; padding: 10px; border-radius: 10px; text-align: center; margin: 5px; font-size: 14px; }
        
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @keyframes bubblePop { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>

<body>
    <div class="snow-container" id="snowContainer"></div>

    <button class="back-button" onclick="window.location.href='index.html'">ğŸ </button>
    <button class="hint-button" onclick="toggleHintPanel()">ğŸ íŒíŠ¸</button>
    <button class="defense-button" onclick="toggleDefensePanel()">ğŸ§£ ë°©ì–´</button>

    <div class="hint-panel" id="hintPanel">
        <h2 style="text-align: center; color: #006400;">ğŸ„ í•„ì‚´ ë‹¨ì–´ ğŸ</h2>
        <div id="killerWordGrid" style="display: grid; grid-template-columns: repeat(2, 1fr);"></div>
        <button onclick="toggleHintPanel()" style="display:block; margin: 20px auto; padding: 10px 20px;">ë‹«ê¸°</button>
    </div>

    <div class="hint-panel" id="defensePanel">
        <h2 style="text-align: center; color: #d62828;">ğŸ§¤ ë°©ì–´ ë‹¨ì–´ ğŸ§£</h2>
        <div id="defenseWordGrid" style="display: grid; grid-template-columns: repeat(2, 1fr);"></div>
        <button onclick="toggleDefensePanel()" style="display:block; margin: 20px auto; padding: 10px 20px;">ë‹«ê¸°</button>
    </div>

    <div class="container">
        <div class="header">
            <h1 class="title">ğŸ… í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ëë§ì‡ê¸° ğŸ„</h1>
            <div class="gecko-points">ì‚°íƒ€ í¬ì¸íŠ¸: <span id="geckoPoints">0</span></div>
        </div>

        <div class="history-bar">
            <div class="word-bubbles" id="wordHistory">
                <div style="color: #666;">Merry Christmas! ì²« ë‹¨ì–´ë¥¼ ë§í•´ë´!</div>
            </div>
        </div>

        <div class="battle-stage">
            <div class="character">
                <img src="santa.jpg" class="character-image">
                <div style="color: white; margin-top: 5px; font-weight: 700;">Santa Claus</div>
            </div>
            <div class="vs-badge">VS</div>
            <div class="character">
                <img src="yulsanta.jpg" class="character-image">
                <div style="color: white; margin-top: 5px; font-weight: 700;">ì¡°ìœ¨</div>
            </div>
        </div>

        <div class="input-area">
            <button class="mic-button" id="micButton">ğŸ„</button>
            <div style="text-align: center;">
                <input type="text" class="text-input" id="textInput" placeholder="ë‹¨ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                <br>
                <button class="submit-button" id="submitButton">ë‹¨ì–´ ë³´ë‚´ê¸° ğŸš€</button>
            </div>
            <div id="statusMessage" style="text-align: center; margin-top: 10px; font-weight: 700; color: #006400;"></div>
        </div>
    </div>

    <div class="victory-popup" id="victoryPopup">
        <div class="victory-content">
            <h2 style="color: #d62828; font-size: 30px;">ğŸ”” ë©”ë¦¬ ìŠ¹ë¦¬! ğŸ””</h2>
            <div id="victoryMessage" style="margin: 20px 0; font-size: 18px;"></div>
            <div id="pointsGained" style="font-size: 24px; font-weight: 900; color: #fb8500; margin-bottom: 20px;"></div>
            <button onclick="restartGame()" style="background: #2b9348; color: white; border: none; padding: 15px 30px; border-radius: 20px; font-size: 18px; cursor: pointer;">ë‹¤ì‹œ í•˜ê¸° â„ï¸</button>
        </div>
    </div>

    <script>
        // 1. ì†Œë¦¬ íŒŒì¼ ì„¤ì • (ê²½ì¾Œí•œ í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ì¢…ì†Œë¦¬ íš¨ê³¼ìŒ)
        const victorySound = new Audio('https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3');

        let geckoPoints = 0;
        let wordHistory = [];
        let currentWord = '';
        let rallyCount = 0;
        let usedWords = [];
        let wordDatabase = [];
        let killerWords = [];
        let defenseWords = [];

        // ëˆˆ ë‚´ë¦¬ëŠ” íš¨ê³¼ í•¨ìˆ˜
        function createSnow() {
            const container = document.getElementById('snowContainer');
            for (let i = 0; i < 50; i++) {
                const snow = document.createElement('div');
                snow.className = 'snowflake';
                const size = Math.random() * 5 + 3 + 'px';
                snow.style.width = size;
                snow.style.height = size;
                snow.style.left = Math.random() * 100 + 'vw';
                snow.style.animationDuration = Math.random() * 3 + 2 + 's';
                snow.style.animationDelay = Math.random() * 5 + 's';
                container.appendChild(snow);
            }
        }
        createSnow();

        // ì‹œíŠ¸ ë°ì´í„° ë¡œë“œ
        async function loadWordsFromSheet() {
            try {
                const SHEET_ID = '1J9AxPD_RfvhL5lJC-qAWIjTb1ucv-k6PdJbCxpJN0vA';
                const SHEET_CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=0`;
                const response = await fetch(SHEET_CSV_URL);
                const csvText = await response.text();
                const lines = csvText.split('\n');

                for (let i = 1; i < lines.length; i++) {
                    const columns = lines[i].split(',');
                    if (columns[0]?.trim()) wordDatabase.push(columns[0].trim());
                    if (columns[1]?.trim()) killerWords.push(columns[1].trim());
                    if (columns[2]?.trim()) defenseWords.push(columns[2].trim());
                }
                populateGrids();
            } catch (e) {
                console.error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨");
            }
        }

        function populateGrids() {
            const kGrid = document.getElementById('killerWordGrid');
            kGrid.innerHTML = '';
            killerWords.forEach(w => {
                const div = document.createElement('div');
                div.className = 'killer-word-item';
                div.textContent = w;
                kGrid.appendChild(div);
            });
            const dGrid = document.getElementById('defenseWordGrid');
            dGrid.innerHTML = '';
            defenseWords.forEach(w => {
                const div = document.createElement('div');
                div.className = 'killer-word-item';
                div.style.background = "#006400";
                div.textContent = w;
                dGrid.appendChild(div);
            });
        }

        function handleUserInput() {
            const input = document.getElementById('textInput');
            const word = input.value.trim();
            if (!word) return;

            if (currentWord && currentWord.charAt(currentWord.length - 1) !== word.charAt(0)) {
                document.getElementById('statusMessage').textContent = "ê¸€ìê°€ ì•ˆ ë§ì•„ìš”! ë‹¤ì‹œ í™•ì¸í•´ë´ìš”.";
                return;
            }
            if (usedWords.includes(word)) {
                document.getElementById('statusMessage').textContent = "ì´ë¯¸ ì“´ ë‹¨ì–´ì˜ˆìš”!";
                return;
            }

            addWord(word, 'user');
            usedWords.push(word);
            currentWord = word;
            rallyCount++;
            input.value = '';

            if (killerWords.includes(word)) {
                showVictory(word);
            } else {
                setTimeout(aiResponse, 800);
            }
        }

        function aiResponse() {
            const lastChar = currentWord.charAt(currentWord.length - 1);
            const possible = wordDatabase.filter(w => w.charAt(0) === lastChar && !usedWords.includes(w));
            
            if (possible.length === 0) {
                showVictory(currentWord, true);
            } else {
                const pick = possible[Math.floor(Math.random() * possible.length)];
                addWord(pick, 'ai');
                usedWords.push(pick);
                currentWord = pick;
                rallyCount++;
            }
        }

        function addWord(word, speaker) {
            const history = document.getElementById('wordHistory');
            if (wordHistory.length === 0) history.innerHTML = '';
            const bubble = document.createElement('div');
            bubble.className = `word-bubble ${speaker}`;
            bubble.textContent = word;
            history.appendChild(bubble);
            wordHistory.push(word);
            bubble.scrollIntoView({ behavior: 'smooth' });
        }

        function showVictory(word, aiGaveUp = false) {
            // ìŠ¹ë¦¬ ì‹œ ì†Œë¦¬ ì¬ìƒ ğŸ””
            victorySound.play().catch(e => console.log("ì†Œë¦¬ ì¬ìƒì„ ìœ„í•´ í™”ë©´ì„ í•œ ë²ˆ í´ë¦­í•´ì£¼ì„¸ìš”!"));

            geckoPoints += rallyCount;
            document.getElementById('geckoPoints').textContent = geckoPoints;
            document.getElementById('victoryMessage').innerHTML = aiGaveUp ? "Santaê°€ ë‹¨ì–´ë¥¼ ëª» ì°¾ì•˜ì–´!<br>ëŒ€ë‹¨í•´, ë„ˆì˜ ìŠ¹ë¦¬ì•¼!" : `<strong>${word}</strong>! ë©‹ì§„ í•„ì‚´ê¸°ì˜€ì–´!`;
            document.getElementById('pointsGained').textContent = `+${rallyCount} í¬ì¸íŠ¸ íšë“!`;
            document.getElementById('victoryPopup').classList.add('show');
        }

        function restartGame() {
            // ì†Œë¦¬ ë„ê¸° ë° ì´ˆê¸°í™” ğŸ”‡
            victorySound.pause();
            victorySound.currentTime = 0;

            wordHistory = []; usedWords = []; currentWord = ''; rallyCount = 0;
            document.getElementById('wordHistory').innerHTML = '<div style="color: #666;">Merry Christmas! ì²« ë‹¨ì–´ë¥¼ ë§í•´ë´!</div>';
            document.getElementById('statusMessage').textContent = '';
            document.getElementById('victoryPopup').classList.remove('show');
        }

        function toggleHintPanel() { document.getElementById('hintPanel').classList.toggle('open'); }
        function toggleDefensePanel() { document.getElementById('defensePanel').classList.toggle('open'); }

        document.getElementById('submitButton').onclick = handleUserInput;
        document.getElementById('textInput').onkeypress = (e) => { if(e.key === 'Enter') handleUserInput(); };
        
        loadWordsFromSheet();
    </script>
</body>
</html>
